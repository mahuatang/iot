package com.soco.car.app.service;

import com.alibaba.dubbo.config.annotation.Reference;
import com.soco.car.app.api.response.BaseResponse;
import com.soco.car.app.constants.ResponseMessageEnum;
import com.soco.car.app.constants.SOCOAppConstant;
import com.soco.car.app.constants.SiteConstant;
import com.soco.car.app.handler.BaseResponseGenerator;
import com.soco.car.car.api.ConfigApi;
import com.soco.car.car.entity.ConfigVersion;
import com.soco.car.user.entity.PhoneVersion;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

@Service
public class ConfigService {
    private static final Logger logger = LoggerFactory.getLogger(ConfigService.class);

    @Reference
    private ConfigApi configApi;

    public BaseResponse isUpgradeVersion(PhoneVersion phoneVersion) {
        Long configId = null;
        if (SiteConstant.SYSTEM_IOS.equalsIgnoreCase(phoneVersion.getSystemname())) {
            configId = SiteConstant.CONFIG_TYPE_IOS;
        } else {
            configId = SiteConstant.CONFIG_TYPE_ANDROID;
        }
        ConfigVersion configVersion = configApi.selectVersionInfo(configId);
        if (configVersion != null) {
            int sysVersion = configVersion.getVersionno();
            int appVersion = Integer.parseInt(phoneVersion.getVersionno());
            if (appVersion >= sysVersion) {
                // 如果版本一致强制设置为不需要升级
                configVersion.setIsupgradeversion(SiteConstant.UPGRADE_TYPE_NO);
                return BaseResponseGenerator.genSuccessResult(configVersion, "查询成功，版本已是最新");
            }  else {
                return BaseResponseGenerator.genSuccessResult("查询成功，发现新版本");
            }
        } else {
            return BaseResponseGenerator.genErrorResult(SOCOAppConstant.ERROR_CODE_400, ResponseMessageEnum.is_update_version_fail.getValue());
        }
    }

    public BaseResponse getUserProductInstructions(String carType) {
        return  BaseResponseGenerator.genSuccessResult(configApi.getUserProductInstructions(carType));
    }
}
